---
title: "Simulations of cancer data,  drug data, and corrresponding cancer drug response data"
author: "Seraphina Shi"
date: "2023-03-17"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include = FALSE, warning=FALSE, message=FALSE, echo=FALSE}
library(here)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(grid)
library(RColorBrewer)
library(gplots)
library(reshape)

plotFolder <- here("images", "simulations")
if(!file.exists(plotFolder)) dir.create(plotFolder,recursive=TRUE)

dataFolder <- here("data", "simulations")
if(!file.exists(dataFolder)) dir.create(dataFolder,recursive=TRUE)

knitr::opts_chunk$set(
  cache=FALSE, autodep=FALSE, warning=FALSE, message=FALSE, echo=TRUE,
  results = 'markup', dev='png', dpi=150, fig.align = "center",
  fig.path=paste0(plotFolder, "/"),
  cache.path=".cache/",
  duplicate.label="allow"
)
```

```{r}
GDSC_folder <- here("data", "GDSC")
```

In this R file, we simulate multiple synthetic samples based on lung cancer cell
lines. 

# Original data
Load GDSC lung cancer cell lines 
```{r}
# cancer data
RNAseq_rpkm <- read.csv(file=here(GDSC_folder, "GDSC_lung_RNAseq_rpkm.csv"), row.names = 1, header= TRUE)
names(RNAseq_rpkm) <- gsub("X", "", names(RNAseq_rpkm))

cl_meta <- read.csv(file=here(GDSC_folder, "GDSC_CellLine_lung_annotation.csv"), header=TRUE)
cl_meta <- cl_meta[cl_meta$COSMIC_ID %in% names(RNAseq_rpkm) & (!is.na(cl_meta$COSMIC_ID)), ]

# drug data

# Cancer drug response data
CDR_auc_bi <- read.csv(file=here(GDSC_folder, "GDSC_DrugResponse_binarized.csv"), row.names = 1, header= TRUE)
names(CDR_auc_bi) <- gsub("X", "", names(CDR_auc_bi))
```

# Simulate data 2 (GDSC, NSCLC + SCLC)
## Cancer 

0. Check cancer types:
```{r fig.width=6, fig.height=7}
cl_meta |> 
  count(cancer_type) |>
  gt::gt(caption = "Lung cancer types")
```

1. Focus on NSCLC and SCLC 
```{r fig.width=6, fig.height=7}
NSCLC_COSMIC <- cl_meta$COSMIC_ID[cl_meta$cancer_type == "NSCLC"]
NSCLC_COSMIC <- NSCLC_COSMIC[!is.na(NSCLC_COSMIC)]
SCLC_COSMIC <- cl_meta$COSMIC_ID[cl_meta$cancer_type == "SCLC"] 
SCLC_COSMIC <- SCLC_COSMIC[!is.na(SCLC_COSMIC)]


NSCLC_RNAseq <- RNAseq_rpkm %>% select(all_of(as.character(NSCLC_COSMIC)))
SCLC_RNAseq <- RNAseq_rpkm %>% select(all_of(as.character(SCLC_COSMIC)))

dim(NSCLC_RNAseq) # [1] 5703   76
dim(SCLC_RNAseq) # [1] 5703   76

RNA_seq <- cbind(NSCLC_RNAseq, SCLC_RNAseq)
```

2.1 select some consistently highly expressed or lowly expressed genes for each
 cancer type.  
2.2. select several genes with high expression variability for each cancer type.   
2.3 keep these genes in the simulated data.  
```{r}
set.seed(123)
row_means <- apply(NSCLC_RNAseq, 1, mean)
row_vars <- apply(NSCLC_RNAseq, 1, var)
summary(row_means)
summary(row_vars)

NSCLC_consistently_high_genes <- row.names(NSCLC_RNAseq)[which(row_vars < 0.35 & (row_means > 0.4 ))] 
NSCLC_consistently_low_genes <- row.names(NSCLC_RNAseq)[which(row_vars < 0.35 & (row_means < -0.4 ))] 
NSCLC_consistently_med_genes <- row.names(NSCLC_RNAseq)[which(row_vars < 0.35 & (-0.1 < row_means & row_means < 0.1))] 

NSCLC_high_var_expressed_genes <- row.names(NSCLC_RNAseq)[which(row_vars > 2.5 )]
c(length(NSCLC_consistently_high_genes), length(NSCLC_consistently_low_genes), length(NSCLC_consistently_med_genes), length(NSCLC_high_var_expressed_genes))



row_means <- apply(SCLC_RNAseq, 1, mean)
row_vars <- apply(SCLC_RNAseq, 1, var)
summary(row_means)
summary(row_vars)

SCLC_consistently_high_genes <- row.names(SCLC_RNAseq)[which(row_vars < 0.35 & (row_means > 0.9 ))] 
SCLC_consistently_low_genes <- row.names(SCLC_RNAseq)[which(row_vars < 0.35 & (row_means < -1 ))] 
SCLC_consistently_med_genes <- row.names(SCLC_RNAseq)[which(row_vars < 0.35 & (-0.1 < row_means & row_means < 0.1))] 

SCLC_high_var_expressed_genes <- row.names(SCLC_RNAseq)[which(row_vars > 5 )]

c(length(SCLC_consistently_high_genes), length(SCLC_consistently_low_genes), length(SCLC_consistently_med_genes), length(SCLC_high_var_expressed_genes) )


selected_genes <- unique(c(NSCLC_consistently_high_genes, NSCLC_consistently_low_genes,
                           NSCLC_consistently_med_genes,  NSCLC_high_var_expressed_genes,
                           SCLC_consistently_high_genes, SCLC_consistently_low_genes,
                           SCLC_consistently_med_genes, SCLC_high_var_expressed_genes ))

random_genes <- sample(row.names(NSCLC_RNAseq)[! row.names(NSCLC_RNAseq) %in% selected_genes], size=50)

all_selected_genes <- unique(c(selected_genes, random_genes))
length(all_selected_genes) 


RNA_seq_s <- RNA_seq %>% 
                    t() %>% as.data.frame() %>% 
                    select(all_of(all_selected_genes)) %>% 
                    t() %>% as.data.frame()

dim(RNA_seq_s)

NSCLC_RNAseq_s <-  NSCLC_RNAseq %>% 
                    t() %>% as.data.frame() %>% 
                    select(all_of(all_selected_genes)) %>% 
                    t() %>% as.data.frame()

SCLC_RNAseq_s <-  SCLC_RNAseq %>% 
                    t() %>% as.data.frame() %>% 
                    select(all_of(all_selected_genes)) %>% 
                    t() %>% as.data.frame()
```

2.4. separate the NSCLC cancers into two groups   
```{r}
cat_genes <- NSCLC_high_var_expressed_genes[1:10]
library(corrplot)
corrplot(cor(t(NSCLC_RNAseq_s[NSCLC_high_var_expressed_genes,])))

apply(NSCLC_RNAseq_s[c("SIDG05348", "SIDG05982", "SIDG09035", "SIDG09036", "SIDG09100", "SIDG10617", "SIDG37641"),], 1, mean)
sep <- NSCLC_RNAseq["SIDG05348",] < 0.5 & NSCLC_RNAseq["SIDG09035",] < 0.5 & 
  NSCLC_RNAseq["SIDG09036",] < 0.5 & NSCLC_RNAseq["SIDG09100",] < 0.5 & NSCLC_RNAseq["SIDG10617",] < 0.5

grp1 <- names(NSCLC_RNAseq_s)[which(sep)]
grp2 <- names(NSCLC_RNAseq_s)[which(!sep)]

grp1_RNAseq <- NSCLC_RNAseq_s %>% 
  select(all_of(as.character(grp1))) 
colnames(grp1_RNAseq) = paste0("c1_", 1:ncol(grp1_RNAseq))

grp2_RNAseq <- NSCLC_RNAseq_s %>% 
  select(all_of(as.character(grp2))) 
colnames(grp2_RNAseq) = paste0("c2_", 1:ncol(grp2_RNAseq))

colnames(SCLC_RNAseq_s) = paste0("c0_", 1:ncol(SCLC_RNAseq_s))


RNAseq_simu <- cbind(cbind(grp1_RNAseq, grp2_RNAseq), SCLC_RNAseq_s)

RNAseq_meta_simu <- cbind(C_ID = colnames(RNAseq_simu), 
                          C_type = c(rep("grp1", length(grp1)), rep("grp2", length(grp2)), rep("grp0", length(SCLC_COSMIC))))

```

2.5. Heatmap of synthetic CCL RNAseq
```{r}
heatmap.2(t(as.matrix(RNAseq_simu)),
          trace="none",
          col = rev(colorRampPalette(brewer.pal(10, "RdYlBu"))(256)) ,
          Colv=FALSE,
          Rowv = FALSE,
          labRow=FALSE,
          labCol=FALSE,
          main = "Heatmap of CCL RNAseq",
          RowSideColors = c(rep("#F4D98E",length(grp1)), rep("#F4D98E", length(grp2)), rep("#94D8D8", length(SCLC_COSMIC))),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
legend(y=0.9, x=-0.13, xpd=TRUE,
       legend = c("A (NSCLC)", "B (SCLC)"),
       col = c("#F4D98E", "#94D8D8"),
       lty= 1, lwd = 5, cex=.7,
       title = "Initial Label"
       )
```


## Drug

Since drug data is complicated and can be expressed through multiple ways, (smile strings, molecular fingerprints, and molecular graphs); we start with fingerprints that are easier to simulate and easier to create the cancer-drug-response functions. 

```{r}
set.seed(123)
  
# 10 drugs to start with
drug_simu_func <- function(n, p, k_fp_idx){
  fp <- matrix(nrow = n, ncol = p)
  for(i in 1:p){
    if(i %in% k_fp_idx){
      fp[,i] = rbinom(n=n, size = 1, prob = 0.95)
    } else {
      fp[, i] = rbinom(n=n, size = 1, prob = 0.5)
    }
  }
  return(fp)
}

n_d = 10
p = 150

d_fp <- rbind(drug_simu_func(n_d, p, 1:25),
              drug_simu_func(n_d, p, 40:65),
              drug_simu_func(n_d, p, 70:95))

colnames(d_fp) <- paste0("f", 1:p)
rownames(d_fp) <- c(paste0("d1_", 1:n_d), paste0("d2_", 1:n_d), paste0("d0_", 1:n_d))

d_fp <- t(d_fp)


heatmap.2(t(as.matrix(d_fp)),
          trace="none",
          # col = c("red", "green") ,
          Colv=FALSE,
          Rowv = FALSE,
          labRow=FALSE,
          main = "Heatmap of Drug Features",
          # RowSideColors = c(rep("#00BFC4",n_d), rep("#F8766D", n_d), rep("#66CD00", n_d)),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
```
    

## Cancer Drug Response [Version 2]
### Simulate CDR with 1s for each sensitive cancer-drug pair and 0s for others
```{r}
n_c =  ncol(RNAseq_simu)
n_d = ncol(d_fp)/3

cdr <- matrix(0, nrow = n_c, ncol = n_d*3)

cdr[1:length(grp1), 1:n_d] = 1
cdr[(length(grp1)+1):(length(grp1)+(length(grp2))), (n_d+1):(n_d*2)] = 1
cdr[(length(grp1)+(length(grp2)+1)):n_c, (n_d*2+1):(n_d*3)] = 1

colnames(cdr) = colnames(d_fp)
rownames(cdr) = colnames(RNAseq_simu)

heatmap.2(t(as.matrix(cdr)),
          trace="none",
          col = c("white", "#6BBC47") ,
          Colv=FALSE,
          Rowv = FALSE,
          main = "Heatmap of True cancer drug response data",
          ColSideColors = c(rep("#94D8D8",length(grp1)), rep("#F19ABC", length(grp2)), rep("#F4D98E", length(SCLC_COSMIC))),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
legend(y=0.9, x=-0.1, xpd=TRUE,
       legend = c("group1","group2","group0"),
       col = c("#94D8D8", "#F19ABC","#F4D98E"),
       lty= 1, lwd = 5, cex=.7
       )
```


```{r}
# write.csv(RNAseq_simu, here(dataFolder, "simu2_RNAseq.csv"))
# write.csv(RNAseq_meta_simu, here(dataFolder, "simu2_RNAseq_meta.csv"))
# write.csv(d_fp, here(dataFolder, "simu2_d_fp.csv"))
# write.csv(cdr, here(dataFolder, "simu2_cdr.csv"))
```


### Add some noise

```{r}
# RNAseq_simu = read.csv(here(dataFolder, "simu2_RNAseq.csv"), row.names = 1)
# RNAseq_meta_simu = read.csv(here(dataFolder, "simu2_RNAseq_meta.csv"), row.names = 1)
# d_fp = read.csv(here(dataFolder, "simu2_d_fp.csv"), row.names = 1)
# cdr = read.csv(here(dataFolder, "simu2_cdr.csv"), row.names = 1)
```

```{r}
set.seed(123)

cdr_r = cdr

random01_num = dim(cdr)[1] * dim(cdr)[2] * 0.1 

random1_row = sample(1:nrow(cdr), random01_num, replace = T)
random1_col = sample(1:ncol(cdr), random01_num, replace = T)

random0_row = sample(1:nrow(cdr), random01_num, replace = T)
random0_col = sample(1:ncol(cdr), random01_num, replace = T)

randomNA_num = dim(cdr)[1] * dim(cdr)[2] * 0.1
randomNA_row = sample(1:nrow(cdr), randomNA_num, replace = T)
randomNA_col = sample(1:ncol(cdr), randomNA_num, replace = T)


for (i in 1:random01_num) {
  cdr_r[random1_row[i], random1_col[i]] = 1
  cdr_r[random0_row[i], random0_col[i]] = 0
  cdr_r[randomNA_row[i], randomNA_col[i]] = NA
}


heatmap.2(as.matrix(cdr_r),
          trace="none",
          col = c("white", "#6BBC47") ,
          Colv=FALSE,
          Rowv = FALSE,
          main = "Heatmap of simulated cancer drug response data",
          RowSideColors = c(rep("#94D8D8",sum(RNAseq_meta_simu[,'C_type'] == "grp1")), 
                            rep("#F19ABC", sum(RNAseq_meta_simu[,'C_type'] == "grp2")), 
                            rep("#F4D98E", sum(RNAseq_meta_simu[,'C_type'] == "grp0"))),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
legend(y=0.9, x=-0.1, xpd=TRUE,
       legend = c("A","B","C"),
       col = c("#94D8D8", "#F19ABC","#F4D98E"),
       lty= 1, lwd = 5, cex=.7,
       title = "Initial Label"
       )
```


```{r}
write.csv(cdr_r, here(dataFolder, "simu2_cdr_noise.csv"))
```

## Cancer Drug Response [Version 2.2]
```{r}
set.seed(123)
n_c =  ncol(RNAseq_simu)
n_d = ncol(d_fp)/3

cdr_2.2_true <- matrix(0, nrow = n_c, ncol = n_d*3)

cdr_2.2_true[1:length(grp1) , 1:(n_d*2)] = 1
cdr_2.2_true[(length(grp1)+1):(length(grp1)+(length(grp2))), (n_d+1):(n_d*2)] = 1
cdr_2.2_true[(length(grp1)+(length(grp2)+1)):n_c, (n_d*2+1):(n_d*3)] = 1

colnames(cdr_2.2_true) = colnames(d_fp)
rownames(cdr_2.2_true) = colnames(RNAseq_simu)

write.csv(cdr_2.2_true, here(dataFolder, "simu2.2_cdr_true.csv"))

heatmap.2(as.matrix(cdr_2.2_true),
          trace="none",
          col = c("white", "#6BBC47") ,
          Colv=FALSE,
          Rowv = FALSE,
          main = "Heatmap of True cancer drug response data",
          RowSideColors = c(rep("#94D8D8",length(grp1)), rep("#F19ABC", length(grp2)), rep("#F4D98E", length(SCLC_COSMIC))),
          ColSideColors = c(rep("#94D8D8",10), rep("#F19ABC", 10), rep("#F4D98E", 10)),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
legend(y=0.9, x=-0.1, xpd=TRUE,
       legend = c("A","B","C"),
       col = c("#94D8D8", "#F19ABC","#F4D98E"),
       lty= 1, lwd = 5, cex=.7,
       title = "Initial Label"
       )
```

```{r}
cdr_2.2 = cdr_2.2_true

random01_num = dim(cdr_2.2_true)[1] * dim(cdr_2.2_true)[2] * 0.05

random1_row = sample(1:nrow(cdr_2.2_true), random01_num, replace = T)
random1_col = sample(1:ncol(cdr_2.2_true), random01_num, replace = T)

random0_row = sample(1:nrow(cdr_2.2_true), random01_num, replace = T)
random0_col = sample(1:ncol(cdr_2.2_true), random01_num, replace = T)

randomNA_num = dim(cdr_2.2_true)[1] * dim(cdr_2.2_true)[2] * 0.15
randomNA_row = sample(1:nrow(cdr_2.2_true), randomNA_num, replace = T)
randomNA_col = sample(1:ncol(cdr_2.2_true), randomNA_num, replace = T)

for (i in 1:random01_num) {
  cdr_2.2[random1_row[i], random1_col[i]] = 1
  cdr_2.2[random0_row[i], random0_col[i]] = 0
  cdr_2.2[randomNA_row[i], randomNA_col[i]] = NA
}

RNAseq_meta_simu <- RNAseq_meta_simu |>
  as.data.frame() |>
  mutate(C_type = ifelse(C_type == "grp2", "grp1", C_type))

set.seed(123)
idx = sample(1:ncol(cdr_2.2), ncol(cdr_2.2), replace = FALSE)
cdr_2.2 = cdr_2.2[, idx]

heatmap.2(as.matrix(cdr_2.2),
          trace="none",
          na.rm=TRUE, na.col="darkgrey",
          col = c("white", "#6BBC47") ,
          Colv=FALSE,
          Rowv = FALSE,
          main = "Heatmap of Cancer Drug Response",
          RowSideColors = c(rep("#F4D98E",sum(RNAseq_meta_simu[,'C_type'] == "grp1")), 
                            rep("#F19ABC", sum(RNAseq_meta_simu[,'C_type'] == "grp2")), 
                            rep("#94D8D8", sum(RNAseq_meta_simu[,'C_type'] == "grp0"))),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
legend(y=0.9, x=-0.1, xpd=TRUE,
       legend = c("A","B"),
       col = c("#F4D98E","#94D8D8"),
       lty= 1, lwd = 5, cex=.7,
       title = "Initial Label"
       )

write.csv(cdr_2.2, here(dataFolder, "simu2.2_cdr_noise.csv"))
write.csv(RNAseq_meta_simu, here(dataFolder, "simu2.2_RNAseq_meta.csv"))

```

## Cancer Drug Response [Version 2.3]
Add more missing values on CDR version 2.2
```{r}
set.seed(123)

more_0_d <- sample(1:ncol(cdr_2.2), 5, replace = F)
for (col in random_missing_col) {
  zero_num <- sample(1:nrow(cdr_2.2), 100, replace = F)
  for (row in zero_num) {
    cdr_2.3[row, col] <- 0
  } 
}

random_missing_row = sample(1:nrow(cdr_2.2), 50, replace = F)
random_missing_col = sample(1:ncol(cdr_2.2), 10, replace = F)

cdr_2.3 = cdr_2.2

for (row in random_missing_row) {
  missing_num <- sample(seq(from = 0.5, to = 0.9, by = 0.1), 1) * ncol(cdr_2.2) |>
    round()
  missing_idx <- sample(1:ncol(cdr_2.3), missing_num, replace = F)
  for (col in missing_idx) {
    cdr_2.3[row, col] <- NA
  }
}

for (col in random_missing_col) {
  missing_num <- sample(seq(from = 0.5, to = 0.9, by = 0.1), 1) * nrow(cdr_2.2) |>
    round()
  missing_idx <- sample(1:nrow(cdr_2.3), missing_num, replace = F)
  for (row in missing_idx) {
    cdr_2.3[row, col] <- NA
  } 
}


heatmap.2(as.matrix(cdr_2.3[, colnames(cdr_2.3) |> sort()]),
          trace="none",
          na.rm=TRUE, na.col="darkgrey",
          col = c("white", "#6BBC47") ,
          Colv=FALSE,
          Rowv = FALSE,
          main = "Heatmap of Cancer Drug Response",
          RowSideColors = c(rep("#F4D98E",sum(RNAseq_meta_simu[,'C_type'] == "grp1")), 
                            rep("#F19ABC", sum(RNAseq_meta_simu[,'C_type'] == "grp2")), 
                            rep("#94D8D8", sum(RNAseq_meta_simu[,'C_type'] == "grp0"))),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
legend(y=0.9, x=-0.1, xpd=TRUE,
       legend = c("A","B"),
       col = c("#F4D98E","#94D8D8"),
       lty= 1, lwd = 5, cex=.7,
       title = "Initial Label"
       )

write.csv(cdr_2.3, here(dataFolder, "simu2.3_cdr.csv"))
write.csv(RNAseq_meta_simu, here(dataFolder, "simu2.3_RNAseq_meta.csv"))

```

```{r}

heatmap.2(t(as.matrix(cdr_2.3)),
          trace="none",
          na.rm=TRUE, na.col="black",
          col = c("white", "#6BBC47") ,
          Colv=FALSE,
          Rowv = FALSE,
          main = "Heatmap of Cancer Drug Response",
          ColSideColors = c(rep("#F4D98E",sum(RNAseq_meta_simu[,'C_type'] == "grp1")), 
                            rep("#F19ABC", sum(RNAseq_meta_simu[,'C_type'] == "grp2")), 
                            rep("#94D8D8", sum(RNAseq_meta_simu[,'C_type'] == "grp0"))),
          key.title = "Color Key\n& Histogram",
          key.xlab=NA,
          keysize=1
          )
legend(y=0.9, x=-0.1, xpd=TRUE,
       legend = c("A","B"),
       col = c("#F4D98E","#94D8D8"),
       lty= 1, lwd = 5, cex=.7,
       title = "Initial Label"
       )
```




